<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‚¤ì˜¤ìŠ¤í¬ ì¥ë‹¨ì  ë¹„êµ ê¸€ì“°ê¸° ë„ìš°ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- NanumGothic Font for jsPDF -->
    <script src="https://unpkg.com/jspdf-autotable@3.5.13/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/yan-s/Leflet.Korean-master/dist/L.Korean-src.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2107@1.1/Pretendard-Regular.woff"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .step-card {
            transition: all 0.5s ease-in-out;
        }
        .hidden-step {
            opacity: 0;
            transform: translateY(20px);
            max-height: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .visible-step {
            opacity: 1;
            transform: translateY(0);
            max-height: 2000px; /* Adjust as needed */
        }
        /* --- Print (ì¸ì‡„ìš©) ìŠ¤íƒ€ì¼: PDF ë‚´ë³´ë‚´ê¸° ì‹œ ì„ íƒ/ê²€ìƒ‰ ê°€ëŠ¥ í…ìŠ¤íŠ¸ ìœ ì§€ --- */
        @media print {
            body { background: white !important; }
            header, #alertModal, #downloadPdf, #printPdf { display: none !important; }
            #step1, #step2 { display: none !important; }
            #step3 { display: block !important; opacity: 1 !important; transform: none !important; max-height: none !important; }
            #pdf-content { box-shadow: none !important; background: white !important; }
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-3xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800">ğŸ¤– í‚¤ì˜¤ìŠ¤í¬ ì¥ë‹¨ì  ê¸€ì“°ê¸° ë„ìš°ë¯¸</h1>
            <p class="text-gray-600 mt-2">AI ì„ ìƒë‹˜ê³¼ í•¨ê»˜ ë‚´ ìƒê°ì„ ë©‹ì§„ ê¸€ë¡œ ì™„ì„±í•´ ë´ìš”!</p>
            <!-- Progress Stepper -->
            <div class="mt-6 flex items-center justify-center gap-3 select-none">
                <div id="stepper-1" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white bg-blue-600">1</div>
                    <span class="text-sm text-blue-700 font-semibold hidden sm:inline">ì •ë³´ ì…ë ¥</span>
                </div>
                <div class="h-px w-12 bg-blue-300"></div>
                <div id="stepper-2" class="flex items-center gap-2 opacity-50">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white bg-yellow-500">2</div>
                    <span class="text-sm text-yellow-700 font-semibold hidden sm:inline">AI ì¡°ì–¸</span>
                </div>
                <div class="h-px w-12 bg-blue-300"></div>
                <div id="stepper-3" class="flex items-center gap-2 opacity-50">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white bg-green-600">3</div>
                    <span class="text-sm text-green-700 font-semibold hidden sm:inline">ìµœì¢… í™•ì¸</span>
                </div>
            </div>
        </header>

        <main id="app" class="space-y-6">
            <!-- Step 1: Info and Initial Draft -->
            <section id="step1" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg step-card visible-step">
                <h2 class="text-2xl font-bold text-blue-700 mb-1">1ë‹¨ê³„: ë‚´ ì •ë³´ì™€ ìƒê° ì²«ê±¸ìŒ</h2>
                <p class="text-gray-500 mb-6">í•™êµ, ë²ˆí˜¸, ì´ë¦„ì„ ì“°ê³  í‚¤ì˜¤ìŠ¤í¬ì— ëŒ€í•œ ë‚´ ìƒê°ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <input type="text" id="schoolName" placeholder="í•™êµ ì´ë¦„" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition">
                    <input type="text" id="classNumber" placeholder="ë²ˆí˜¸ (ì˜ˆ: 4í•™ë…„ 1ë°˜ 1ë²ˆ)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition">
                    <input type="text" id="studentName" placeholder="í•™ìƒ ì´ë¦„" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div class="relative">
                    <textarea id="initialDraft" class="w-full p-4 border border-gray-300 rounded-lg h-64 resize-none focus:ring-2 focus:ring-blue-500 transition" placeholder="ì—¬ê¸°ì— í‚¤ì˜¤ìŠ¤í¬ì˜ ì¥ì ê³¼ ë‹¨ì ì„ ë¹„êµí•˜ê³  ë‚´ ì˜ê²¬ì„ ì¨ì£¼ì„¸ìš”. (ìµœì†Œ 600ì ì´ìƒ)"></textarea>
                    <div id="charCounter" class="absolute bottom-3 right-3 text-sm text-gray-500">0 / 600ì</div>
                </div>
                <button id="submitForReview" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
                    AI ì„ ìƒë‹˜ê»˜ ê²€í†  ë°›ê¸°
                </button>
            </section>

            <!-- Step 2: AI Feedback and Revision -->
            <section id="step2" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg step-card hidden-step">
                <h2 class="text-2xl font-bold text-yellow-600 mb-1">2ë‹¨ê³„: AI ì„ ìƒë‹˜ì˜ ì¡°ì–¸ê³¼ ê¸€ ë‹¤ë“¬ê¸°</h2>
                <p class="text-gray-500 mb-6">AI ì„ ìƒë‹˜ì˜ ì¡°ì–¸ì„ ì°¸ê³ í•´ì„œ ê¸€ì„ ë” ë©‹ì§€ê²Œ ë§Œë“¤ì–´ ë³´ì„¸ìš”!</p>

                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">âœï¸ ë‚´ê°€ ì²˜ìŒ ì“´ ê¸€</h3>
                    <div id="displayInitialDraft" class="p-4 bg-gray-100 rounded-lg text-gray-800 whitespace-pre-wrap max-h-52 overflow-y-auto"></div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">ğŸ’¡ AI ì„ ìƒë‹˜ì˜ ì¡°ì–¸</h3>
                    <div id="aiFeedback" class="p-4 bg-yellow-100 border-l-4 border-yellow-400 rounded-lg text-yellow-800 whitespace-pre-wrap max-h-52 overflow-y-auto">
                        <div id="loader" class="flex items-center justify-center space-x-2">
                            <svg class="animate-spin h-5 w-5 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>AI ì„ ìƒë‹˜ì´ ê¸€ì„ ê¼¼ê¼¼íˆ ì½ê³  ìˆì–´ìš”. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-gray-700 mb-2">âœï¸ ì¡°ì–¸ì„ ë³´ê³  ê³ ì³ ì“´ ê¸€</h3>
                    <textarea id="revisedDraft" class="w-full p-4 border border-gray-300 rounded-lg h-64 resize-none focus:ring-2 focus:ring-yellow-500 transition" placeholder="AI ì„ ìƒë‹˜ì˜ ì¡°ì–¸ì„ ì°¸ê³ í•˜ì—¬ ê¸€ì„ ë‹¤ë“¬ì–´ ë³´ì„¸ìš”."></textarea>
                </div>

                <button id="submitFinal" class="mt-6 w-full bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition-transform transform hover:scale-105 shadow-md disabled:opacity-60 disabled:cursor-not-allowed" disabled>
                    ê¸€ì“°ê¸° ì™„ë£Œ!
                </button>
            </section>

            <!-- Step 3: Final Review and Download -->
            <section id="step3" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg step-card hidden-step">
                <div id="pdf-content">
                    <h2 class="text-2xl font-bold text-green-700 mb-1">ğŸ‰ ì™„ì„±! ìµœì¢… ê²°ê³¼ í™•ì¸í•˜ê¸°</h2>
                    <p class="text-gray-500 mb-6">ì •ë§ ì˜í–ˆì–´ìš”! ì•„ë˜ì—ì„œ ìµœì¢… ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  PDFë¡œ ì €ì¥í•´ì„œ ì œì¶œí•˜ì„¸ìš”.</p>
                    <div class="bg-gray-100 p-4 rounded-lg mb-4 text-center">
                        <span id="finalSchool" class="font-bold"></span> | <span id="finalNumber" class="font-bold"></span> | <span id="finalName" class="font-bold"></span>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-bold text-blue-600 mb-2 border-b-2 border-blue-200 pb-1">âœï¸ ì²˜ìŒ ì“´ ê¸€</h3>
                            <div id="finalInitialDraft" class="p-3 bg-blue-50 rounded-md text-gray-800 whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-yellow-600 mb-2 border-b-2 border-yellow-200 pb-1">ğŸ’¡ AI ì„ ìƒë‹˜ì˜ ì¡°ì–¸</h3>
                            <div id="finalAiFeedback" class="p-3 bg-yellow-50 rounded-md text-gray-800 whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-green-600 mb-2 border-b-2 border-green-200 pb-1">âœï¸ ê³ ì³ ì“´ ê¸€</h3>
                            <div id="finalRevisedDraft" class="p-3 bg-green-50 rounded-md text-gray-800 whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button id="downloadPdf" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 shadow-md">
                        PDFë¡œ ì €ì¥ (ì„ë² ë””ë“œ í°íŠ¸)
                    </button>
                    <button id="printPdf" class="w-full bg-white text-green-700 font-bold py-3 px-6 rounded-lg border border-green-300 hover:bg-green-50 transition-transform transform hover:scale-105 shadow-md">
                        ì¸ì‡„/ë‚´ë³´ë‚´ê¸° (ì‹œìŠ¤í…œ PDF)
                    </button>
                </div>
            </section>
        </main>
        
        <!-- Custom Alert Modal -->
        <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4">
                <div id="alertIcon" class="text-5xl mb-4"></div>
                <p id="alertMessage" class="text-lg text-gray-700 mb-6"></p>
                <button id="closeModal" class="bg-red-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-red-600 transition">í™•ì¸</button>
            </div>
        </div>

    </div>

<script>
    // --- DOM Elements ---
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');

    const schoolNameInput = document.getElementById('schoolName');
    const classNumberInput = document.getElementById('classNumber');
    const studentNameInput = document.getElementById('studentName');
    const initialDraftTextarea = document.getElementById('initialDraft');
    const charCounter = document.getElementById('charCounter');
    
    const submitForReviewBtn = document.getElementById('submitForReview');
    
    const displayInitialDraftDiv = document.getElementById('displayInitialDraft');
    const aiFeedbackDiv = document.getElementById('aiFeedback');
    const loader = document.getElementById('loader');
    const revisedDraftTextarea = document.getElementById('revisedDraft');
    const submitFinalBtn = document.getElementById('submitFinal');

    const pdfContentDiv = document.getElementById('pdf-content');
    const finalSchoolSpan = document.getElementById('finalSchool');
    const finalNumberSpan = document.getElementById('finalNumber');
    const finalNameSpan = document.getElementById('finalName');
    const finalInitialDraftDiv = document.getElementById('finalInitialDraft');
    const finalAiFeedbackDiv = document.getElementById('finalAiFeedback');
    const finalRevisedDraftDiv = document.getElementById('finalRevisedDraft');
    const downloadPdfBtn = document.getElementById('downloadPdf');
    const printPdfBtn = document.getElementById('printPdf');
    
    const alertModal = document.getElementById('alertModal');
    const alertIcon = document.getElementById('alertIcon');
    const alertMessage = document.getElementById('alertMessage');
    const closeModalBtn = document.getElementById('closeModal');


    // --- App State ---
    let studentData = {
        school: '',
        number: '',
        name: '',
        initialDraft: '',
        aiFeedback: '',
        revisedDraft: ''
    };
    const MIN_CHARS = 600;
    let aiReviewReceived = false;
    let isLoadingAI = false;
    let isKoreanFontReady = false;

    // --- Functions ---
    
    function customAlert(message, icon = 'âš ï¸') {
        alertMessage.textContent = message;
        alertIcon.textContent = icon;
        alertModal.classList.remove('hidden');
    }

    function updateStepper(activeIndex) {
        const steps = [
            document.getElementById('stepper-1'),
            document.getElementById('stepper-2'),
            document.getElementById('stepper-3')
        ];
        steps.forEach((el, idx) => {
            if (idx < activeIndex) {
                el.classList.remove('opacity-50');
            } else if (idx === activeIndex) {
                el.classList.remove('opacity-50');
            } else {
                el.classList.add('opacity-50');
            }
        });
    }

    function changeStep(hide, show, activeIndex) {
        hide.classList.remove('visible-step');
        hide.classList.add('hidden-step');
        setTimeout(() => {
            show.classList.remove('hidden-step');
            show.classList.add('visible-step');
            window.scrollTo(0, 0);
            updateStepper(activeIndex);
        }, 300);
    }
    
    async function getAIReview(text) {
        loader.style.display = 'flex';
        aiFeedbackDiv.textContent = '';
        aiFeedbackDiv.appendChild(loader);
        isLoadingAI = true;
        submitForReviewBtn.disabled = true;

        try {
            const response = await fetch('/api/review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });

            if (!response.ok) {
                throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
            }

            const result = await response.json();
            if (result && result.feedback) {
                aiReviewReceived = true;
                return result.feedback;
            }
            return "ì£„ì†¡í•´ìš”, AI ì„ ìƒë‹˜ì´ ì§€ê¸ˆ ì¡°ê¸ˆ ë°”ìœê°€ ë´ìš”. ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        } catch (error) {
            console.error('AI Review Error:', error);
            return "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        } finally {
            isLoadingAI = false;
            submitForReviewBtn.disabled = false;
        }
    }

    async function ensureKoreanFont(pdf) {
        if (isKoreanFontReady) return;
        try {
            // NanumGothic Regular TTF (Korean) - public CDN
            const fontUrl = 'https://cdn.jsdelivr.net/gh/fonts-archive/NanumGothic/NanumGothic-Regular.ttf';
            const res = await fetch(fontUrl);
            const buf = await res.arrayBuffer();
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
            pdf.addFileToVFS('NanumGothic-Regular.ttf', base64);
            pdf.addFont('NanumGothic-Regular.ttf', 'NanumGothic', 'normal');
            isKoreanFontReady = true;
        } catch (e) {
            console.error('í°íŠ¸ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ í°íŠ¸ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.', e);
        }
    }

    async function generatePdf() {
        const button = downloadPdfBtn;
        button.textContent = "PDF ìƒì„± ì¤‘...";
        button.disabled = true;

        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            // --- Font Setting (ì„ë² ë””ë“œ í•œê¸€ í°íŠ¸) ---
            await ensureKoreanFont(pdf);
            pdf.setFont(isKoreanFontReady ? 'NanumGothic' : 'Helvetica', 'normal');

            const FONT_SIZES = {
                title: 16,
                header: 11,
                subtitle: 13,
                body: 10
            };
            const LINE_HEIGHT = 7;
            const MARGIN = 15;
            const PAGE_WIDTH = pdf.internal.pageSize.getWidth();
            const MAX_WIDTH = PAGE_WIDTH - (MARGIN * 2);
            let y = MARGIN; 

            const addTextWithWrap = (text, options) => {
                const { size, isTitle = false, isSubtitle = false } = options;
                pdf.setFontSize(size);
                
                if (isTitle) pdf.setTextColor(40, 58, 112);
                else if (isSubtitle) pdf.setTextColor(29, 78, 216);
                else pdf.setTextColor(51, 65, 85);
                
                const lines = pdf.splitTextToSize(text, MAX_WIDTH);
                
                if (y + (lines.length * (LINE_HEIGHT - 1)) > pdf.internal.pageSize.getHeight() - MARGIN) {
                    pdf.addPage();
                    y = MARGIN;
                }
                
                pdf.text(lines, MARGIN, y);
                y += (lines.length * (LINE_HEIGHT - 1)); 
                y += 6; 
            };
            
            addTextWithWrap('í‚¤ì˜¤ìŠ¤í¬ ì¥ë‹¨ì  ê¸€ì“°ê¸° ê²°ê³¼', { size: FONT_SIZES.title, isTitle: true });
            y += 3;

            const studentInfo = `í•™êµ: ${studentData.school} | ë²ˆí˜¸: ${studentData.number} | ì´ë¦„: ${studentData.name}`;
            addTextWithWrap(studentInfo, { size: FONT_SIZES.header });
            y += 8;
            
            addTextWithWrap('âœï¸ ì²˜ìŒ ì“´ ê¸€', { size: FONT_SIZES.subtitle, isSubtitle: true });
            addTextWithWrap(studentData.initialDraft, { size: FONT_SIZES.body });
            
            addTextWithWrap('ğŸ’¡ AI ì„ ìƒë‹˜ì˜ ì¡°ì–¸', { size: FONT_SIZES.subtitle, isSubtitle: true });
            addTextWithWrap(studentData.aiFeedback, { size: FONT_SIZES.body });

            addTextWithWrap('âœï¸ ê³ ì³ ì“´ ê¸€', { size: FONT_SIZES.subtitle, isSubtitle: true });
            addTextWithWrap(studentData.revisedDraft, { size: FONT_SIZES.body });

            const fileName = `${studentData.school}_${studentData.number}_${studentData.name}_í‚¤ì˜¤ìŠ¤í¬ê¸€ì“°ê¸°.pdf`;
            pdf.save(fileName);

        } catch (error) {
            console.error("PDF ìƒì„± ì˜¤ë¥˜:", error);
            customAlert("PDFë¥¼ ë§Œë“œëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "âŒ");
        } finally {
            button.textContent = "PDFë¡œ ì €ì¥ (ì„ë² ë””ë“œ í°íŠ¸)";
            button.disabled = false;
        }
    }


    // --- Event Listeners ---
    initialDraftTextarea.addEventListener('input', () => {
        const textLength = initialDraftTextarea.value.length;
        charCounter.textContent = `${textLength} / ${MIN_CHARS}ì`;
        if (textLength >= MIN_CHARS) {
            charCounter.style.color = 'green';
        } else {
            charCounter.style.color = 'gray';
        }
    });

    submitForReviewBtn.addEventListener('click', async () => {
        const school = schoolNameInput.value.trim();
        const number = classNumberInput.value.trim();
        const name = studentNameInput.value.trim();
        const draft = initialDraftTextarea.value.trim();

        if (!school || !number || !name) {
            customAlert('í•™êµ, ë²ˆí˜¸, ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'ğŸ“');
            return;
        }
        if (draft.length < MIN_CHARS) {
            customAlert(`ê¸€ì„ ì¡°ê¸ˆ ë” ê¸¸ê²Œ ì¨ì£¼ì„¸ìš”. ìµœì†Œ ${MIN_CHARS}ì ì´ìƒì´ì–´ì•¼ í•´ìš”!`, 'âœï¸');
            return;
        }

        studentData = { ...studentData, school, number, name, initialDraft: draft };
        aiReviewReceived = false;

        changeStep(step1, step2, 1);
        
        displayInitialDraftDiv.textContent = studentData.initialDraft;
        revisedDraftTextarea.value = studentData.initialDraft;
        
        const feedback = await getAIReview(studentData.initialDraft);
        studentData.aiFeedback = feedback;
        
        loader.style.display = 'none';
        aiFeedbackDiv.textContent = studentData.aiFeedback;

        // ê²Œì´íŠ¸: AI ê²€í† ë¥¼ ë°›ì•„ì•¼ 2ë‹¨ê³„ ì™„ë£Œ ê°€ëŠ¥
        if (aiReviewReceived && studentData.aiFeedback && !studentData.aiFeedback.includes('ì˜¤ë¥˜ê°€ ë°œìƒ')) {
            submitFinalBtn.disabled = false;
        } else {
            submitFinalBtn.disabled = true;
        }
    });

    submitFinalBtn.addEventListener('click', () => {
        if (!aiReviewReceived) {
            customAlert('AI ì„ ìƒë‹˜ì˜ ê²€í† ë¥¼ ë¨¼ì € ë°›ì•„ì•¼ í•´ìš”!', 'ğŸ¤–');
            return;
        }
        studentData.revisedDraft = revisedDraftTextarea.value.trim();

        if(studentData.revisedDraft.length < MIN_CHARS) {
            customAlert(`ê³ ì³ ì“´ ê¸€ë„ ${MIN_CHARS}ì ì´ìƒì´ì–´ì•¼ í•´ìš”!`, 'âœï¸');
            return;
        }
        
        // Populate final view
        finalSchoolSpan.textContent = studentData.school;
        finalNumberSpan.textContent = studentData.number;
        finalNameSpan.textContent = studentData.name;
        finalInitialDraftDiv.textContent = studentData.initialDraft;
        finalAiFeedbackDiv.textContent = studentData.aiFeedback;
        finalRevisedDraftDiv.textContent = studentData.revisedDraft;

        changeStep(step2, step3, 2);
    });

    downloadPdfBtn.addEventListener('click', generatePdf);
    printPdfBtn.addEventListener('click', () => window.print());
    
    closeModalBtn.addEventListener('click', () => {
        alertModal.classList.add('hidden');
    });

</script>
</body>
</html>

